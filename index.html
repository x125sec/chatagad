<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Omegle-Style Chat with Firebase</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { 
      getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, deleteDoc, addDoc, collection, query, where, getDocs 
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyALyckXNK7FbzpqZGP4Lr5eVRQJVseh0fQ",
      authDomain: "chatagad-app.firebaseapp.com",
      projectId: "chatagad-app",
      storageBucket: "chatagad-app.firebasestorage.app",
      messagingSenderId: "946806283279",
      appId: "1:946806283279:web:78ad7293e5a0a2017dd77a",
      measurementId: "G-7J5TKXQB1X"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentChatId = null;
    let queueRef = null;
    let chatUnsub = null;
    let messagesUnsub = null;

    const statusEl = document.getElementById("status");
    const messagesEl = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    function appendMessage(sender, text) {
      const msgDiv = document.createElement("div");
      msgDiv.className = sender === "me" ? "text-right text-blue-500" : "text-left text-green-500";
      msgDiv.textContent = text;
      messagesEl.appendChild(msgDiv);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    async function joinQueue() {
      statusEl.textContent = "Joining queue...";
      queueRef = doc(db, "queue", currentUser.uid);
      await setDoc(queueRef, { timestamp: Date.now() });

      // Search for another user in the queue
      const q = query(collection(db, "queue"), where("__name__", "!=", currentUser.uid));
      const snapshot = await getDocs(q);
      if (!snapshot.empty) {
        const other = snapshot.docs[0];
        // Create a chat
        const chatRef = doc(collection(db, "chats"));
        await setDoc(chatRef, { 
          user1: currentUser.uid,
          user2: other.id
        });
        // Remove both from queue
        await deleteDoc(queueRef);
        await deleteDoc(other.ref);
        startChat(chatRef.id);
      } else {
        // Wait until matched
        onSnapshot(doc(db, "queue", currentUser.uid), async (docSnap) => {
          if (!docSnap.exists()) {
            // Probably matched by another user
            // Find our chat
            const chatQ = query(
              collection(db, "chats"), 
              where("user1", "==", currentUser.uid)
            );
            const chatSnap = await getDocs(chatQ);
            if (!chatSnap.empty) {
              startChat(chatSnap.docs[0].id);
            } else {
              const chatSnap2 = await getDocs(
                query(collection(db, "chats"), where("user2", "==", currentUser.uid))
              );
              if (!chatSnap2.empty) {
                startChat(chatSnap2.docs[0].id);
              }
            }
          }
        });
      }
    }

    function startChat(chatId) {
      currentChatId = chatId;
      statusEl.textContent = "Connected! Say hi!";
      // Listen for messages
      const msgsRef = collection(db, "chats", chatId, "messages");
      messagesUnsub = onSnapshot(msgsRef, (snap) => {
        snap.docChanges().forEach(change => {
          if (change.type === "added") {
            const data = change.doc.data();
            appendMessage(data.sender === currentUser.uid ? "me" : "other", data.text);
          }
        });
      });
    }

    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      const msgsRef = collection(db, "chats", currentChatId, "messages");
      await addDoc(msgsRef, { sender: currentUser.uid, text, timestamp: Date.now() });
      messageInput.value = "";
    }

    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    // Auto-remove from queue when leaving
    window.addEventListener("beforeunload", async () => {
      if (queueRef) {
        try {
          await deleteDoc(queueRef);
        } catch {}
      }
    });

    // Start
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        joinQueue();
      } else {
        await signInAnonymously(auth);
      }
    });
  </script>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center h-screen">
  <h1 class="text-2xl font-bold mb-4">Omegle-Style Chat</h1>
  <div id="status" class="mb-4">Connecting...</div>
  <div id="messages" class="bg-gray-800 p-4 w-96 h-64 overflow-y-auto mb-4 rounded"></div>
  <div class="flex w-96">
    <input id="messageInput" class="flex-1 p-2 rounded-l text-black" placeholder="Type a message..." />
    <button id="sendBtn" class="bg-blue-500 px-4 rounded-r">Send</button>
  </div>
</body>
</html>
